# V2 Updated on 2025/12/22. Corrected bottom horizontal axis date alignment. 
# You must gain Fred api key to run it. Anybody can gain the access for free  
# https://fred.stlouisfed.org/docs/api/api_key.html

import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from fredapi import Fred
import numpy as np

# --- Configuration ---
FRED_API_KEY = ''
fred = Fred(api_key=FRED_API_KEY)

START_DATE = '2019-11-01' 
END_DATE = datetime.today().strftime('%Y-%m-%d')
GDP_FETCH_START_DATE = '2017-10-01' 

# --- 1. Data Retrieval and Processing ---

print(f"Fetching and processing data from FRED: {START_DATE} to {END_DATE}...")

# a) Construct a continuous Reserve Interest Rate (IORB/IORR)
iorb_current = fred.get_series('IORB', observation_start=START_DATE, observation_end=END_DATE)
iorr_predecessor = fred.get_series('IORR', observation_start=START_DATE, observation_end=END_DATE)
iorb_continuous = iorb_current.combine_first(iorr_predecessor)
sofr_daily = fred.get_series('SOFR', observation_start=START_DATE, observation_end=END_DATE)
df_spread = pd.DataFrame({'SOFR': sofr_daily, 'IORB': iorb_continuous})
df_spread = df_spread.dropna()
spread_series = df_spread['SOFR'] - df_spread['IORB']

# b) FETCH TOTAL RESERVES (TOTRESNS)
total_reserves = fred.get_series('TOTRESNS', observation_start=START_DATE, observation_end=END_DATE)
total_reserves = total_reserves * 1_000_000_000 
total_reserves_monthly = total_reserves.resample('ME').mean()

# --- RESERVES ZERO GROWTH FORECASTING ---
last_res_date = total_reserves_monthly.dropna().index[-1]
last_res_val = total_reserves_monthly.loc[last_res_date]
res_forecast_dates = pd.date_range(start=last_res_date + pd.DateOffset(months=1), end=END_DATE, freq='ME')
res_forecast = pd.Series(last_res_val, index=res_forecast_dates)
reserves_full = pd.concat([total_reserves_monthly, res_forecast]).sort_index()

# c) Fetch Nominal GDP (GDP) - Quarterly
gdp_data_quarterly = fred.get_series('GDP', observation_start=GDP_FETCH_START_DATE, observation_end=END_DATE) 
gdp_data_quarterly = gdp_data_quarterly * 1_000_000_000 

# --- GDP ZERO GROWTH FORECASTING LOGIC ---
last_gdp_date = gdp_data_quarterly.dropna().index[-1]
zero_growth_factor = 1.0 
current_quarter_end = pd.to_datetime(END_DATE).to_period('Q').end_time 
forecast_end_date = (current_quarter_end + pd.DateOffset(months=3)).to_period('Q').end_time
gdp_forecast = pd.Series(dtype=float)
current_forecast_value = gdp_data_quarterly.loc[last_gdp_date]
current_forecast_date = last_gdp_date
while current_forecast_date < forecast_end_date:
    current_forecast_date = current_forecast_date + pd.DateOffset(months=3)
    current_forecast_value *= zero_growth_factor 
    gdp_forecast.loc[current_forecast_date] = current_forecast_value
gdp_data_full = pd.concat([gdp_data_quarterly, gdp_forecast]).sort_index()
gdp_data_monthly = gdp_data_full.resample('QE').ffill().resample('ME').ffill()

# d) Combine and Calculate Ratio 
df_ratio = pd.DataFrame({'Total_Reserves': reserves_full, 'GDP': gdp_data_monthly}).ffill()
df_ratio = df_ratio.loc[START_DATE:END_DATE]
ratio_series = (df_ratio['Total_Reserves'] / df_ratio['GDP']) * 100

split_date_ratio = min(last_gdp_date, last_res_date)
ratio_actual = ratio_series.loc[ratio_series.index <= split_date_ratio]
ratio_implied = ratio_series.loc[ratio_series.index >= split_date_ratio]

# e) Calculate Z-Score Normalized Series (for Graph 4)
common_start = pd.to_datetime(START_DATE)
spread_for_zscore = spread_series.loc[common_start:]
ratio_for_zscore = ratio_series.loc[common_start:]
spread_zscore = (spread_for_zscore - spread_for_zscore.mean()) / spread_for_zscore.std()
ratio_zscore = (ratio_for_zscore - ratio_for_zscore.mean()) / ratio_for_zscore.std()
df_combined = pd.DataFrame({'Spread_ZScore': spread_zscore, 'Ratio_ZScore': ratio_zscore}).ffill()

# --- HELPER FUNCTION TO FIX AXIS ---
def fix_x_axis(ax):
    ax.set_xlim(pd.to_datetime(START_DATE), pd.to_datetime(END_DATE))
    ax.margins(x=0) # Removes the "blank space" at the start/end
    ax.xaxis.set_major_locator(mdates.YearLocator()) # Ticks at start of each year
    ax.xaxis.set_minor_locator(mdates.MonthLocator(bymonth=[1, 4, 7, 10])) # Quarterly marks
    ax.xaxis.set_major_formatter(mdates.DateFormatter("%Y"))
    # Add a specific label for the start date if desired
    ax.annotate(f'Start: {START_DATE}', xy=(pd.to_datetime(START_DATE), 0), 
                xycoords=('data', 'axes fraction'), textcoords='offset points', 
                xytext=(0,-30), ha='center', fontsize=8, color='gray')

# --- 2. Graph 1: SOFR - IORB Spread ---
fig1, ax1 = plt.subplots(figsize=(10, 5)) 
ax1.plot(spread_series.index, spread_series, color='tab:blue', linewidth=0.5, label='SOFR - IORB Spread (Daily)') 
ax1.axhline(0, color='black', linestyle='-', linewidth=1.5, label='Zero Spread')
fix_x_axis(ax1)
ax1.set_title('Graph 1: SOFR - IORB Spread (Percentage Points)', fontsize=14)
ax1.set_ylabel('Spread (Percentage Points)')
ax1.grid(True, linestyle='--', alpha=0.4)
ax1.legend(loc='upper left')

# --- 3. Graph 2: Total Reserves / U.S. GDP ---
fig2, ax2 = plt.subplots(figsize=(10, 5)) 
ax2.plot(ratio_actual.index, ratio_actual, color='tab:red', linewidth=2, label='Total Reserves / GDP (%) (Actual)')
ax2.plot(ratio_implied.index, ratio_implied, color='tab:red', linewidth=2, linestyle='--', label='Implied Forecast')
ax2.axhline(11, color='black', linestyle='--', linewidth=1.5, label='11% Target')
ax2.axhline(10, color='purple', linestyle='--', linewidth=1.5, label='10% Target')
fix_x_axis(ax2)
ax2.set_title('Graph 2: Total Reserves as Percentage of U.S. Nominal GDP', fontsize=14)
ax2.set_ylabel('Total Reserves / GDP (%)')
ax2.grid(True, linestyle='--', alpha=0.4)
ax2.legend(loc='upper left')

# --- 4. Graph 3: Combined Dual-Axis Chart ---
fig3, ax_spread = plt.subplots(figsize=(10, 5))
ax_ratio = ax_spread.twinx() 

line1, = ax_spread.plot(spread_series.index, spread_series, color='lightslategrey', linewidth=1.5, label='SOFR - IORB Spread (LHS)') 
ax_spread.set_ylabel('SOFR - IORB Spread', color='lightslategrey')
ax_spread.set_ylim(-0.20, 0.30) 

line2, = ax_ratio.plot(ratio_actual.index, ratio_actual, color='red', linewidth=2, label='Reserves/GDP (Actual, RHS)')
line3, = ax_ratio.plot(ratio_implied.index, ratio_implied, color='red', linewidth=2, linestyle='--', label='Reserves/GDP (Implied, RHS)')
ax_ratio.set_ylabel('Total Reserves / GDP (%)', color='red')
ax_ratio.set_ylim(5.0, 20.0) 

# Thresholds
l11 = ax_ratio.axhline(11, color='black', linestyle='-', linewidth=1.5, label='11% Threshold')
l10 = ax_ratio.axhline(10, color='red', linestyle=':', linewidth=1.0, label='10% Threshold')

fix_x_axis(ax_spread)
ax_spread.set_title('Graph 3: Combined Liquidity and Systemic Ratios (Dual Axis)', fontsize=16)
lines = [line1, line2, line3, l11, l10]
ax_spread.legend(lines, [l.get_label() for l in lines], loc='upper left', fontsize='small')

# --- 5. Graph 4: Z-Score Normalized Chart ---
fig4, ax4 = plt.subplots(figsize=(10, 5)) 
ax4.plot(ratio_zscore.index, ratio_zscore, color='red', linewidth=2, label='Total Reserves/GDP (Z-Score)')
ax4.plot(df_combined.index, df_combined['Spread_ZScore'], color='lightslategrey', linewidth=1.5, label='SOFR-IORB Spread (Z-Score)')
ax4.axhline(0, color='black', linestyle='-', linewidth=1.5) 
ax4.axhline(-1, color='purple', linestyle='-', linewidth=1.5, label='-1 Std Dev')
fix_x_axis(ax4)
ax4.set_title('Graph 4: Normalized Liquidity and Systemic Ratios (Z-Scores)', fontsize=16)
ax4.legend(loc='upper right') 
ax4.grid(True, linestyle='--', alpha=0.4)

plt.tight_layout()
plt.show()


plt.tight_layout()
plt.show()
