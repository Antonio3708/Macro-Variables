import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from fredapi import Fred
from datetime import datetime
import numpy as np

# --- Configuration ---
# ⚠️ REPLACE THIS WITH YOUR ACTUAL FRED API KEY
FRED_API_KEY = ''
fred = Fred(api_key=FRED_API_KEY)

# Define the unified analysis window
START_DATE = '2018-04-01' 
END_DATE = datetime.today().strftime('%Y-%m-%d') 
GDP_FETCH_START_DATE = '2017-10-01' 

# --- 1. Data Retrieval and Processing (Zero Growth Forecast Model) ---

print(f"Fetching and processing data from FRED: {START_DATE} to {END_DATE}...")

# a) Construct a continuous Reserve Interest Rate (IORB/IORR)
iorb_current = fred.get_series('IORB', observation_start=START_DATE, observation_end=END_DATE)
iorr_predecessor = fred.get_series('IORR', observation_start=START_DATE, observation_end=END_DATE)
iorb_continuous = iorb_current.combine_first(iorr_predecessor)
sofr_daily = fred.get_series('SOFR', observation_start=START_DATE, observation_end=END_DATE)
df_spread = pd.DataFrame({'SOFR': sofr_daily, 'IORB': iorb_continuous})
df_spread = df_spread.dropna()
spread_series = df_spread['SOFR_IORB_Spread'] = df_spread['SOFR'] - df_spread['IORB']

# b) FETCH TOTAL RESERVES (TOTRESNS)
total_reserves = fred.get_series('TOTRESNS', observation_start=START_DATE, observation_end=END_DATE)
total_reserves = total_reserves * 1_000_000_000 
total_reserves_monthly = total_reserves.resample('ME').mean()

# c) Fetch Nominal GDP (GDP) - Quarterly
gdp_data_quarterly = fred.get_series('GDP', observation_start=GDP_FETCH_START_DATE, observation_end=END_DATE) 
gdp_data_quarterly = gdp_data_quarterly * 1_000_000_000 

# --- GDP ZERO GROWTH FORECASTING LOGIC ---
last_gdp_date = gdp_data_quarterly.dropna().index[-1]
zero_growth_factor = 1.0 
current_quarter_end = pd.to_datetime(END_DATE).to_period('Q').end_time 
forecast_end_date = (current_quarter_end + pd.DateOffset(months=3)).to_period('Q').end_time
gdp_forecast = pd.Series(dtype=float)
current_forecast_value = gdp_data_quarterly.loc[last_gdp_date]
current_forecast_date = last_gdp_date
while current_forecast_date < forecast_end_date:
    current_forecast_date = current_forecast_date + pd.DateOffset(months=3)
    current_forecast_value *= zero_growth_factor 
    gdp_forecast.loc[current_forecast_date] = current_forecast_value
gdp_data_full = pd.concat([gdp_data_quarterly, gdp_forecast]).sort_index()
gdp_data_monthly = gdp_data_full.resample('QE').ffill().resample('ME').ffill()
# --- END GDP ZERO GROWTH FORECASTING LOGIC ---

# d) Combine and Calculate Ratio 
df_ratio = pd.DataFrame({'Total_Reserves': total_reserves_monthly, 'GDP': gdp_data_monthly}).dropna()
df_ratio = df_ratio.loc[START_DATE:].dropna() 
ratio_series = df_ratio['Total_Reserves_GDP'] = (df_ratio['Total_Reserves'] / df_ratio['GDP']) * 100

# Identify the split point for plotting
split_date_ratio = (last_gdp_date + pd.DateOffset(months=3)).to_period('M').start_time
ratio_actual = ratio_series.loc[ratio_series.index < split_date_ratio]
ratio_implied = ratio_series.loc[ratio_series.index >= split_date_ratio]

# e) Calculate Z-Score Normalized Series (for Graph 4)
common_start = max(spread_series.index.min(), ratio_series.index.min())
spread_for_zscore = spread_series.loc[common_start:]
ratio_for_zscore = ratio_series.loc[common_start:]
spread_zscore = (spread_for_zscore - spread_for_zscore.mean()) / spread_for_zscore.std()
ratio_zscore = (ratio_for_zscore - ratio_for_zscore.mean()) / ratio_for_zscore.std()
df_combined = pd.DataFrame({'Spread_ZScore': spread_zscore, 'Ratio_ZScore': ratio_zscore}).dropna()


# --- 2. Graph 1: SOFR - IORB Spread (Original Values, Natural Bounds) ---
fig1, ax1 = plt.subplots(figsize=(10, 5)) 
ax1.plot(spread_series.index, spread_series, color='tab:blue', linewidth=0.5, label='SOFR - IORB Spread (Daily)') 
ax1.axhline(0, color='black', linestyle='-', linewidth=1.5, label='Zero Spread (Neutral)')
ax1.set_xlim(pd.to_datetime(START_DATE), pd.to_datetime(END_DATE))
ax1.xaxis.set_major_locator(mdates.MonthLocator(interval=12)) 
ax1.xaxis.set_major_formatter(mdates.DateFormatter("%Y")) 
ax1.set_title('Graph 1: SOFR - IORB Spread (Percentage Points)', fontsize=14)
ax1.set_xlabel('Date')
ax1.set_ylabel('Spread (Percentage Points)')
ax1.grid(True, linestyle='--', alpha=0.6)
ax1.legend(loc='upper left')


# --- 3. Graph 2: Total Reserves / U.S. GDP (Zero Growth Forecast) ---
fig2, ax2 = plt.subplots(figsize=(10, 5)) 
ax2.plot(ratio_actual.index, ratio_actual, color='tab:red', linewidth=2, label='Total Reserves / GDP (%) (Actual)')
ax2.plot(ratio_implied.index, ratio_implied, color='tab:red', linewidth=2, linestyle='--', label='Implied Forecast')
ax2.annotate('Zero Growth Forecast', 
             xy=(ratio_implied.index[0], ratio_implied.iloc[0]),
             xytext=(ratio_implied.index[0] + pd.DateOffset(months=3), ratio_implied.iloc[0] + 0.5), 
             arrowprops=dict(facecolor='black', shrink=0.05, width=1, headwidth=6),
             fontsize=10, color='gray')
ax2.axhline(11, color='black', linestyle='--', linewidth=1.5, label='11% Target Threshold')
ax2.axhline(10, color='purple', linestyle='--', linewidth=1.5, label='10% Target Threshold')
ax2.set_xlim(pd.to_datetime(START_DATE), pd.to_datetime(END_DATE))
ax2.xaxis.set_major_locator(mdates.MonthLocator(interval=12)) 
ax2.xaxis.set_major_formatter(mdates.DateFormatter("%Y")) 
ax2.set_title('Graph 2: Total Reserves as Percentage of U.S. Nominal GDP', fontsize=14)
ax2.set_xlabel('Date')
ax2.set_ylabel('Total Reserves / GDP (%)')
ax2.grid(True, linestyle='--', alpha=0.6)
ax2.legend(loc='upper left')


# --- 4. Graph 3: Combined Dual-Axis Chart (Graph 1 + Graph 2, Final Aesthetic) ---

fig3, ax_spread = plt.subplots(figsize=(10, 5))
ax_ratio = ax_spread.twinx() # Secondary Y-axis

# Plot 1: SOFR Spread (LHS)
line1, = ax_spread.plot(spread_series.index, spread_series, color='lightslategrey', 
                        linewidth=1.5, label='SOFR - IORB Spread (LHS)') 
ax_spread.set_ylabel('SOFR - IORB Spread (Percentage Points)', color='lightslategrey')
ax_spread.tick_params(axis='y', labelcolor='lightslategrey')

# Y-AXIS CONSTRAINTS FOR SPREAD (LHS)
ax_spread.set_ylim(-0.20, 0.30) 
ax_spread.axhline(0, color='lightslategrey', linestyle='-', linewidth=0.8) # Thinner zero line

# Plot 2: Total Reserves / GDP (RHS)
line2, = ax_ratio.plot(ratio_actual.index, ratio_actual, color='red', 
                       linewidth=2, label='Reserves/GDP (Actual, RHS)')
line3, = ax_ratio.plot(ratio_implied.index, ratio_implied, color='red', 
                       linewidth=2, linestyle='--', label='Reserves/GDP (Implied, RHS)')
ax_ratio.set_ylabel('Total Reserves / GDP (%)', color='red')
ax_ratio.tick_params(axis='y', labelcolor='red')

# --- FINAL RHS Y-AXIS ADJUSTMENT ---
# Set max bound to 20.0 and min bound to 5.0 for optimal spacing around 11%
ax_ratio.set_ylim(bottom=5.0, top=20.0) 

# THRESHOLD LINES FOR RATIO (RHS)
line_8 = ax_ratio.axhline(8, color='purple', linestyle='-', linewidth=1.5, label='8% Threshold')
line_10 = ax_ratio.axhline(10, color='red', linestyle=':', linewidth=1.0, label='10% Threshold')
line_11 = ax_ratio.axhline(11, color='black', linestyle='-', linewidth=1.5, label='11% Threshold')

# General Customization
ax_spread.set_xlim(pd.to_datetime(START_DATE), pd.to_datetime(END_DATE))
ax_spread.xaxis.set_major_locator(mdates.MonthLocator(interval=12))
ax_spread.xaxis.set_major_formatter(mdates.DateFormatter("%Y")) 
ax_spread.set_xlabel('Date')

# Combine legends
lines = [line1, line2, line3, line_8, line_10, line_11]
labels = [l.get_label() for l in lines]
ax_spread.legend(lines, labels, loc='upper left', fontsize='small')

ax_spread.set_title('Graph 3: Combined Liquidity and Systemic Ratios (Dual Axis, Final Style)', fontsize=16)


# --- 5. Graph 4: Z-Score Normalized Chart (Zero Growth Forecast) ---

fig4, ax4 = plt.subplots(figsize=(10, 5)) 

# Plot 1: Normalized Total Reserves/GDP 
ax4.plot(ratio_zscore.loc[ratio_zscore.index < split_date_ratio].index, 
         ratio_zscore.loc[ratio_zscore.index < split_date_ratio], 
         color='red', linewidth=2, label='Total Reserves/GDP (Z-Score)')
ax4.plot(ratio_zscore.loc[ratio_zscore.index >= split_date_ratio].index, 
         ratio_zscore.loc[ratio_zscore.index >= split_date_ratio], 
         color='red', linewidth=2, linestyle='--', label='Total Reserves/GDP (Implied)')


# Plot 2: Normalized SOFR-IORB Spread (Blue/Grey line)
ax4.plot(df_combined.index, df_combined['Spread_ZScore'], color='lightslategrey', 
         linewidth=1.5, label='SOFR-IORB Spread (Z-Score)')

# Add Horizontal Lines
ax4.axhline(0, color='black', linestyle='-', linewidth=1.5) 
ax4.axhline(-1, color='purple', linestyle='-', linewidth=1.5, label='-1 Std Dev')

# Customization
ax4.set_xlim(pd.to_datetime(START_DATE), pd.to_datetime(END_DATE))
ax4.xaxis.set_major_locator(mdates.MonthLocator(interval=12)) 
ax4.xaxis.set_major_formatter(mdates.DateFormatter("%Y")) 

ax4.set_title('Graph 4: Normalized Liquidity and Systemic Ratios (Z-Scores, Zero Growth Forecast)', fontsize=16)
ax4.set_xlabel('Date')
ax4.set_ylabel('Z-Score') 
ax4.grid(True, linestyle='--', alpha=0.6)
ax4.legend(loc='upper right') 


plt.tight_layout()
plt.show()
